const machine=document.querySelector("#machine"),discount=document.querySelector("#discount"),agreementvalue=document.querySelector("#agreementvalue"),resumen=document.querySelector("#resumen"),business=document.querySelector("#business"),client=document.querySelector("#client"),dataAdd=document.querySelector("#dataAdd"),iniquote=document.querySelector("#iniquote"),quoteper=document.querySelector("#quoteper"),separation=document.querySelector("#separation"),percentValue=document.querySelector("#percentValue"),nquote=document.querySelector("#nquote"),sald=document.querySelector("#sald"),anadir=document.querySelector("#anadir"),comments=document.querySelector("#comments"),quotevalue=document.querySelector("#quotevalue");async function generateAgreement(){const e=new FormData;e.append("client_id",client.value),e.append("business_id",business.value),e.append("machine_id",machine.value),e.append("discount",discount.value),e.append("agreementvalue",agreementvalue.value),e.append("nquote",nquote.value),e.append("quoteini",iniquote.value),e.append("separation",separation.value),e.append("comments",comments.value),e.append("percentinicial",quoteper.value),e.append("quotevalue",quotevalue.value);const n=`${window.location.protocol}//${window.location.hostname}/agreements/add`,t=await fetch(n,{method:"POST",body:e});"ok"===await t.json()&&viewAgreement()}async function viewAgreement(){const e=`${window.location.protocol}//${window.location.hostname}/agreements/searchagreement`,n=await fetch(e),t=await n.json();t&&paymentsGenerate(t.id,t.nquote,t.quotevalue)}async function paymentsGenerate(e,n,t){const a=new FormData;a.append("agreement_id",e),a.append("quotevalue",t),a.append("nquote",n);const o=`${window.location.protocol}//${window.location.hostname}/estimateds/add`,r=await fetch(o,{method:"POST",body:a});"ok"!==await r.json()||window.location.replace(`${window.location.protocol}//${window.location.hostname}/agreements/view/${e}`)}async function searchClient(e){const n=`${window.location.protocol}//${window.location.hostname}/client/searchClientBusiness?id=${e}`,t=await fetch(n),a=await t.json();if("error"!=a){let e='<option value="">-- Seleccione una opcion --</option>';for(let n=0;n<a.length;n++)e+=`<option value="${a[n].id}">${a[n].name}</option>`;client.disabled=!1,machine.disabled=!1,client.innerHTML=e}else client.disabled=!0,client.value=0}async function searchId(e){const n=`${window.location.protocol}//${window.location.hostname}/machines/searchId?id=${e}`,t=await fetch(n),a=await t.json(),o=parseInt(a.value),r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(o);resumen.innerHTML+=`\n                        <tr>\n                            <th scope="row">Maquina</th>\n                            <td>${a.name}</td>\n                        </tr>\n                        <tr>\n                            <th scope="row">Valor de la maquina</th>\n                            <td>${r}</td>\n                        </tr>`,discount.addEventListener("focusout",e=>{const n=e.target.value,t=o-n,a=100*n/o;percentValue.value=a,agreementvalue.value=t;const r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(agreementvalue.value);resumen.innerHTML+=`\n                            <tr>\n                                <th scope="row">Descuento</th>\n                                <td>${percentValue.value}%</td>\n                                <td>$ ${discount.value} USD</td>\n                            </tr>\n                            <tr>\n                                <th scope="row">Valor de la Venta</th>\n                                <td>${r}</td>\n                            </tr>\n                                \n                                `}),separation.addEventListener("focusout",e=>{const n=e.target.value,t=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(n);resumen.innerHTML+=`<tr>\n                                <th scope="row">Separacion</th>\n                                <td>${t}</td>\n                            </tr>`}),quoteper.addEventListener("focusout",e=>{const n=e.target.value,t=agreementvalue.value*n/100-separation.value,a=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t);iniquote.value=t;const o=agreementvalue.value-t-separation.value,r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(o);sald.value=o,resumen.innerHTML+=`<tr>\n                                <th scope="row">Cuota Inicial</th>\n                                <td>${n}%</td>\n                                <td>${a}</td>\n                            </tr>\n                            <tr>\n                                <th scope="row">Saldo</th>\n                                <td>${r}</td>\n                            </tr>`}),nquote.addEventListener("focusout",e=>{const n=e.target.value,t=Math.round(sald.value/n),a=t+function(e,n){let t=0;for(let a=0;a<e;a++){t+=n*(e-a)}return t}(n,.39*t/100)/n,o=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(a);resumen.innerHTML+=`<tr>\n                                <th scope="row">Numero de Cuotas</th>\n                                <td>${nquote.value}</td>\n                            </tr>\n                            <tr>\n                                <th scope="row">Valor de la Cuota</th>\n                                <td>${o}</td>\n                            </tr>`,quotevalue.value=a})}machine.disabled=!0,machine.addEventListener("change",e=>{const n=e.target.value;0!=n?(dataAdd.style.display="block",searchId(n)):dataAdd.style.display="none"}),business.addEventListener("change",e=>{searchClient(e.target.value)}),anadir.addEventListener("click",e=>{e.preventDefault;const n=Swal.mixin({customClass:{confirmButton:"btn btn-success",cancelButton:"btn btn-danger"},buttonsStyling:!1});n.fire({title:"Antes de Continuar",text:"Se generara un nuevo acuerdo comercial, esta informacion no se podra editar despues Â¿Deseas continuar?",icon:"info",showCancelButton:!0,confirmButtonText:"Generar Contrato",cancelButtonText:"Cancelar",reverseButtons:!0}).then(e=>{e.isConfirmed?(generateAgreement(),n.fire("Exito","Tu acuerdo comercial se ha generado con exito!","success")):e.dismiss===Swal.DismissReason.cancel&&n.fire("Cancelled","Your imaginary file is safe :)","error")})});